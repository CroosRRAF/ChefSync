<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart API Test</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>ChefSync Cart API Test</h1>
    
    <div id="results"></div>
    
    <button onclick="testLogin()">1. Login</button>
    <button onclick="testGetFoods()">2. Get Foods</button>
    <button onclick="testAddToCart()">3. Add to Cart</button>
    <button onclick="testGetCart()">4. Get Cart</button>
    
    <script>
        let accessToken = '';
        let testPriceId = '';
        
        const API_BASE = 'http://localhost:8000/api';
        const results = document.getElementById('results');
        
        function log(message) {
            results.innerHTML += '<div>' + message + '</div>';
            console.log(message);
        }
        
        async function testLogin() {
            try {
                const response = await axios.post(`${API_BASE}/auth/login/`, {
                    email: 'customer@example.com',
                    password: 'customer123'
                });
                
                accessToken = response.data.access;
                log('✅ Login successful! Token: ' + accessToken.substring(0, 50) + '...');
                
                // Set default authorization header
                axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;
                
            } catch (error) {
                log('❌ Login failed: ' + error.response?.data?.detail || error.message);
            }
        }
        
        async function testGetFoods() {
            try {
                const response = await axios.get(`${API_BASE}/food/customer/foods/`);
                const foods = response.data;
                
                if (foods.length > 0) {
                    const food = foods[0];
                    log(`✅ Found ${foods.length} foods. Testing with: ${food.name}`);
                    
                    // Get prices for this food
                    const priceResponse = await axios.get(`${API_BASE}/food/customer/foods/${food.food_id}/prices/`);
                    const prices = priceResponse.data;
                    
                    if (prices.length > 0) {
                        testPriceId = prices[0].price_id;
                        log(`✅ Found ${prices.length} prices. Using price: ${prices[0].size} - $${prices[0].price} (ID: ${testPriceId})`);
                    }
                }
                
            } catch (error) {
                log('❌ Get foods failed: ' + (error.response?.data?.error || error.message));
            }
        }
        
        async function testAddToCart() {
            if (!testPriceId) {
                log('❌ No price ID available. Get foods first!');
                return;
            }
            
            try {
                const response = await axios.post(`${API_BASE}/orders/cart/add_to_cart/`, {
                    price_id: testPriceId,
                    quantity: 2,
                    special_instructions: 'Test from browser'
                });
                
                log('✅ Added to cart: ' + JSON.stringify(response.data, null, 2));
                
            } catch (error) {
                log('❌ Add to cart failed: ' + JSON.stringify(error.response?.data || error.message, null, 2));
            }
        }
        
        async function testGetCart() {
            try {
                const response = await axios.get(`${API_BASE}/orders/cart/cart_summary/`);
                log('✅ Cart summary: ' + JSON.stringify(response.data, null, 2));
                
            } catch (error) {
                log('❌ Get cart failed: ' + JSON.stringify(error.response?.data || error.message, null, 2));
            }
        }
    </script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        #results { border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-height: 500px; overflow-y: scroll; }
    </style>
</body>
</html>